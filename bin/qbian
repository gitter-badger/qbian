#!/usr/bin/env bash
# Package
package=$( basename $0 );
################
# http://stackoverflow.com/questions/630372/determine-the-path-of-the-executing-bash-script
BASE="`dirname \"$0\"`"
BASE=$( cd "$BASE/../" && pwd )
if [ -z "$BASE" ] ; then
  exit 1
fi

QBIAN_DISK_DIR="$BASE/Provision/disks"
QBIAN_MINIBIAN_DIR="$BASE/Provision/minibian"
export "BASE=$BASE"
export "PROVISION=$BASE/Provision"
export "QBIAN_DISK_DIR=$QBIAN_DISK_DIR"
export "QBIAN_MINIBIAN_DIR=$QBIAN_MINIBIAN_DIR"
export "QBASE=$BASE/qemu_boot"

while test $# -gt 0; do
        case "$1" in
                -h|--help)
                echo "$package - tool-set for running minibian with qemu & provisioning images"
                echo " "
                echo "$package <application> [arguments]"
                echo " "
                echo "options:"
                echo "$package --create-default null, \"creates a default image using the injects/default\""
                echo "$package --create-img <NAME> <CONFIG> <ROOT_INJECT_DIR> <RESIZE:{optional}>"
                echo "$package --run-img <NAME> <SSH_PORT>, \"run an image with qemu\""
                echo "$package --list null, \"list available images\""
                echo "$package --remove <IMG_NAME> # remove an image"
                exit 0
                ;;
                --run-img)
                  if [ $# -eq 3 ]; then
                    NAME=$2
                    SSH_PORT=$3
                    CONFIG=$(cat $QBIAN_DISK_DIR/$NAME/config.qemu)
                    $QBASE/start.sh $QBIAN_DISK_DIR/$NAME/2015-02-18-wheezy-minibian.img $SSH_PORT "$CONFIG"
                  else
                    echo "Not enough params"
                    echo "$package --run-img <NAME> <SSH_PORT>"
                  fi
                  shift
                  ;;
                --run-sd)
                  if [ ! $# -eq 3 ]; then
                    echo "Error , not enough params"
                    echo "$ qbian --run-sd /dev/sdc 5522 \"config\""
                    exit 1
                  fi

                  DEVICE=$2
                  SSH=$3
                  CONFIG=$4
                  echo $#
                  clear && echo "Launching qemu with sd $DEVICE"
                  $QBASE/start.sh $DEVICE $SSH "$CONFIG"
                  shift
                  ;;
                --list)
                      echo "----------------------------------------|"
                  if [ ! -d $QBIAN_DISK_DIR/default/ ]; then
                    echo "ERR : Default image needs to be created"
                      echo "----------------------------------------|"
                    exit 2
                  fi
                  for i in $( ls -d $QBIAN_DISK_DIR/*/ );
                    do
                      echo $(basename $i)
                      echo $(cat $QBIAN_DISK_DIR/$(basename $i)/config.qemu)
                      echo "--------------------------------------|"
                    done
                  shift
                  ;;
                --skel)
                  if [ $# -eq 2 ]; then
                    NAME=$2
                    rsync -avz $BASE/Provision/InjectSkeleton/* $BASE/injects/$NAME
                  else
                    echo "Not enough params $ qbian --skel <NAME>"
                  fi
                  exit 0
                ;;
                --create-img)
                  if [ "$#" -eq 4 ] || [ "$#" -eq 5 ]; then
                  NAME=$2 # name
                  CONFIG=$3 # config
                  RESIZE=$4 # resize
                  BASE_IMAGE=$5 # base img path
                  # TODO -> ensure INJECT folder has necessary folder structure , skel , ssh etc
                    if [ ! -z "$BASE_IMAGE" ]; then
                      export BASE_IMAGE="$QBIAN_DISK_DIR/$BASE_IMAGE/2015-02-18-wheezy-minibian.img"
                    fi
                    if [ ! -d "$QBIAN_DISK_DIR/$NAME" ]; then
                      mkdir -p $QBIAN_DISK_DIR/$NAME && \
                      if [ ! -d $BASE/injects/$NAME ]; then
                        rsync -avz $BASE/Provision/InjectSkeleton/* $BASE/injects/$NAME
                      fi
                      echo "$CONFIG" > $QBIAN_DISK_DIR/$NAME/config.qemu && \
                      $QBIAN_MINIBIAN_DIR/minibian-qemu.sh $NAME "$BASE/injects/$NAME" "$RESIZE"
                    else
                      echo "Image \"$NAME\" is already available, use $ qbian --run $NAME <SSH>"
                      echo $QBIAN_DISK_DIR/$NAME
                    fi
                  else
                    echo "Not enough Params"
                    echo "$package --create-img <NAME> <CONFIG> <RESIZE:{optional}> <IMG:{optional}>"
                    echo "root/Provision.sh is also required"
                  fi
                  exit 0
                        ;;
                  --remove)
                    if [ $# -eq 2 ] && [ -d "$QBIAN_DISK_DIR/$2" ]; then
                      rm -Rfv $QBIAN_DISK_DIR/$2
                    else
                      echo "Error --remove , $2 not found"
                    fi
                    shift
                    ;;
                  --create-default)
                    if [ ! -d "$QBIAN_DISK_DIR/default" ]; then
                      ssh-keygen -t rsa -f $PROVISION/ssh/qbianssh -N "" -C "your_email@youremail.com" && \
                      cat $PROVISION/ssh/qbianssh.pub > $PROVISION/ssh/authorized_keys && \
                      $BASE/bin/qbian --create-img default "-redir tcp:1374::1374" 512M
                    else
                      echo "image \"default\" already available, use $ $package --run-img default 5522"
                    fi
                    shift
                    ;;
                  --create-sd)
                    if test $# -eq 4; then
                      echo $#
                      echo $0
                      echo $1
                      echo $2
                      echo $3
                      echo $4
                      echo "Create"
                    else
                      echo "Not enough Params"
                    fi
                    shift
                  ;;
                --export)
                NAME=$2
                PATH=$3
                  if [ ! $# -eq 3 ]; then
                    echo "Not enough params"
                    echo "$package --export <NAME> <DEVICE|PATH>"
                    echo "$package --export default /dev/sdc"
                    echo "$package --export default ~/Path/tp/create/image.img"
                    exit 1
                  fi
                  if [ -f $QBIAN_DISK_DIR/$NAME/2015-02-18-wheezy-minibian.img ]; then
                    echo "Exporting $NAME to $PATH"
                    /usr/bin/sudo /usr/bin/dd if=$QBIAN_DISK_DIR/$NAME/2015-02-18-wheezy-minibian.img of=$PATH bs=4M
                  else
                    echo "ERROR : No minibian image found"
                  fi
                  break
                  ;;
                  --import)
                  PATH=$2
                  NAME=$3
                  CONFIG=$4
                    if [ ! $# -eq 4 ]; then
                      echo "Not enough params"
                      echo "$package --import <DEVICE|PATH> <NAME> <CONFIG>"
                      echo "$package --import /dev/sdc imported \"-redir tcp:1374::1374\""
                      echo "$package --import ~/Path/tp/create/image.img imported \"-redir tcp:1374::1374\""
                      exit 1
                    fi
                    if [ ! -d $QBIAN_DISK_DIR/$NAME ]; then
                      /usr/bin/mkdir $QBIAN_DISK_DIR/$NAME && \
                      echo "$CONFIG" > $QBIAN_DISK_DIR/$NAME/config.qemu && \
                      echo "Importing $NAME to $PATH" && \
                      /usr/bin/sudo /usr/bin/dd if=$PATH of=$QBIAN_DISK_DIR/$NAME/2015-02-18-wheezy-minibian.img bs=4M && \
                      echo "Import complete - please chown the imported image"
                    else
                      echo "ERROR : image alread abailable"
                    fi
                    break
                    ;;
                --clear)
                  rand=$RANDOM
                  mv $QBIAN_DISK_DIR/DISK-HERE.txt $BASE/$rand && \
                  rm -Rf $QBIAN_DISK_DIR/* && \
                  mv $BASE/$rand $QBIAN_DISK_DIR/DISK-HERE.txt
                  shift
                  ;;
                *)
                  echo ""
                  break
                ;;
        esac
done
